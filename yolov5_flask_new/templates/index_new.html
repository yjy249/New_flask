
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>云预警平台操作系统</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>
<style>
    i {
        font-style: normal;
    }

    li {
        cursor: pointer;

    }

    html,
    body {
        width: 100%;
        height: 100%;
        background-color: #000066;
    }

    body {
        min-width: 680px;
    }

    * {
        margin: 0;
        padding: 0;
    }

    ul li {
        padding: 0;
        margin: 0;
        list-style: none
    }

    .content {
        width: 100%;
        /*height: 500px;*/
        height: 61%;
        display: flex;
        background-color: #000066;
        justify-content: space-between;
    }

    .header_top {
        height: 50px;
        width: 100%;
        position: relative;
    }

    .logo {
        position: absolute;
        height: 100%;
        width: 100%;
    }

    .logo h1{
        color:white;
        padding:12px;
        margin-top:-10px;
    }

    .content_left {
        width: 49%;
        background-color: #333366;
        height: 94%;
        margin-left:12px;
        position: relative;
    }

    .content_right {
        width: 49%;
        background-color: #333366;
        margin-right:12px;
        height: 94%;
        position: relative;
    }

    .file-input {
        margin-top:-30px;
        margin-left:860px;
    }

    input[type="submit"] {
        background-color: #333366;
        color: white;
        padding: 7px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    input:valid {
        border: 2px solid #333366;
    }

    .content_right img {
        height: 99.6%;
        width: 99.6%;
        padding: 2px;
    }

    .footer {
        width: 100%;
        height: 30%;
        margin-top: 25px;
        display: flex;
        justify-content: space-between;
    }

    .footer_left {
        position: relative;
        width: 100%;
        margin-left:12px;
        margin-right:12px;
    }

    .footer_left table {
        border: 1px solid black;
        border-collapse: collapse;
        width: 100%;
        font-family: Arial, sans-serif;
        font-size: 14px;
    }

    .footer_left td, th {
        padding: 10px;
        border: 1px solid black;
        background-color: #333366;
        color: white;
    }

    .footer_left td:hover {
        background-color: #003399;
    }

</style>

<script>
    function updateTime() {
      var now = new Date();
      var hours = now.getHours();
      var minutes = now.getMinutes();
      var seconds = now.getSeconds();
      var timeString = hours + ':' + minutes + ':' + seconds;
      document.getElementById('time').innerHTML = timeString;
    }
    setInterval(updateTime, 1000);
</script>
<body>
    <div class="header_top">
        <div class="logo">
            <h1>高速公路检测系统</h1>
        </div>
    </div>
    <div class="content" id="content_id">
        <div class="content_left" >
            <div id="map" >
                <!--引用百度地图API-->
<!--                <style type="text/css">-->
<!--                    .iw_poi_title {color:#CC5522;font-size:14px;font-weight:bold;overflow:hidden;padding-right:13px;white-space:nowrap}-->
<!--                    .iw_poi_content {font:12px arial,sans-serif;overflow:visible;padding-top:4px;white-space:-moz-pre-wrap;word-wrap:break-word}-->
<!--                </style>-->
                <script type="text/javascript" src="http://api.map.baidu.com/api?key=&v=1.1&services=true"></script>
            </div>
            <body>
              <!--百度地图容器-->
              <div style="width:830px;height:520px;border:#ccc solid 1px;margin-left:3px;margin-top:2px" id="dituContent"></div>
            </body>
            <script type="text/javascript">
                //创建和初始化地图函数：
                function initMap(){
                    createMap();//创建地图
                    setMapEvent();//设置地图事件
                    addMapControl();//向地图添加控件
                }

                //创建地图函数：
                function createMap(){
                    var map = new BMap.Map("dituContent");//在百度地图容器中创建一个地图
                    var point = new BMap.Point(116.395645,39.929986);//定义一个中心点坐标
                    map.centerAndZoom(point,12);//设定地图的中心点和坐标并将地图显示在地图容器中
                    window.map = map;//将map变量存储在全局
                }

                //地图事件设置函数：
                function setMapEvent(){
                    map.enableDragging();//启用地图拖拽事件，默认启用(可不写)
                    map.enableScrollWheelZoom();//启用地图滚轮放大缩小
                    map.enableDoubleClickZoom();//启用鼠标双击放大，默认启用(可不写)
                    map.enableKeyboard();//启用键盘上下左右键移动地图
                }

                //地图控件添加函数：
                function addMapControl(){
                    //向地图中添加缩放控件
                var ctrl_nav = new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_LEFT,type:BMAP_NAVIGATION_CONTROL_LARGE});
                map.addControl(ctrl_nav);
                    //向地图中添加缩略图控件
                var ctrl_ove = new BMap.OverviewMapControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,isOpen:1});
                map.addControl(ctrl_ove);
                    //向地图中添加比例尺控件
                var ctrl_sca = new BMap.ScaleControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT});
                map.addControl(ctrl_sca);
                }


                initMap();//创建和初始化地图
            </script>
            <!--============================================================================-->
        </div>
        <div class="content_right">
            <img id="image2" src="{{ url_for('video_feed') }}">
        </div>
    </div>
    <div class="file-input">
        <form  id="start" action="/video" enctype='multipart/form-data' method='POST' >
            <input type="file" name="file">
            <input type="submit" value="检测">
        </form>
    </div>
    <div id="time" style="margin-left:1200px;margin-top:-30px;color:white;"></div>
    <div class="footer">
        <div class="footer_left">
            <table id="tfhover" border="1" style="text-align:center">
                <tr><th>序号</th><th>报警时间</th><th>报警事件</th><th>报警描述</th><th>行驶方向</th><th>设备点位</th><th>点位限速</th><th>所属路段</th><th>报警级别</th><th>操作</th></tr>
                <tr><td >1</td><td>2023-04-24 16:22:05</td><td>道面抛洒物</td><td >箱子</td><td>天津->北京</td><td>k74+600</td><td>80km/h</td><td>京沪高速</td><td>优先处理</td><td><a href="" target="_blank" style="color:#0066cc">查看</a></td></tr>
                <tr><td >2</td><td>2023-04-24 17:35:26</td><td>道面抛洒物</td><td >箱子</td><td>天津->北京</td><td>k73+500</td><td>80km/h</td><td>京沪高速</td><td>优先处理</td><td><a href="" target="_blank" style="color:#0066cc">查看</a></td></tr>
                <tr><td >3</td><td>2023-04-24 17:35:26</td><td>道面抛洒物</td><td >废弃金属</td><td>天津->北京</td><td>k73+500</td><td>80km/h</td><td>京沪高速</td><td>优先处理</td><td><a href="" target="_blank" style="color:#0066cc">查看</a></td></tr>
                <tr><td >4</td><td>2023-04-24 16:22:05</td><td>道面抛洒物</td><td >箱子</td><td>天津->北京</td><td>k74+600</td><td>80km/h</td><td>京沪高速</td><td>优先处理</td><td><a href="" target="_blank" style="color:#0066cc">查看</a></td></tr>
                <tr><td >5</td><td>2023-04-24 16:22:05</td><td>道面抛洒物</td><td >箱子</td><td>天津->北京</td><td>k74+600</td><td>80km/h</td><td>京沪高速</td><td>优先处理</td><td><a href="" target="_blank" style="color:#0066cc">查看</a></td></tr>
                <tr><td >6</td><td>2023-04-24 16:22:05</td><td>道面抛洒物</td><td >箱子</td><td>天津->北京</td><td>k74+600</td><td>80km/h</td><td>京沪高速</td><td style="color:red">优先处理</td><td><a href="" target="_blank" style="color:#0066cc">查看</a></td></tr>
            </table>
        </div>
    </div>
    <script>


        let cameraDom = ''
        let cameraData = ''
        let playr = ''
        var deviceDataList = [];

        layui.config({
            base: 'layuiadmin/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use('index');
        $("#username").html("云预警");
        var typeurl = "";
        if ($.getUrlParam("typeurl") != null) {
            typeurl = $.getUrlParam("typeurl");
        }
        // var bottomId = document.getElementById('bottom_id')
        // bottomId.style.display = 'none'
        //
        // var contentId = document.getElementById('content_id')
        // contentId.style.height = '61%'

        //   设备1  摄像头编号
        var videoNumber = 'G45899441'
        var init = true;
        if(ls_uid != "006"){
            $("#imageLogo").attr("src", "../img/title.png");
            $("#imageLogo").attr("style", "margin-left:0px;");
        }
        if (ls_isclean == "是") {
        $(".screen_hidden").attr("style", "display:none;");
    } else {
        $(".green_hidden").attr("style", "display:none;");
    }


        $('#bjjl').click(function () {
            document.getElementById("zprw").style.display = "block"
            $('#bj')[0].style.display = 'block'
            $('#sb')[0].style.display = 'none'
            // $('.dispatch')[0].style.display = 'block'


        })
        $('#sbxx').click(function () {
            $('#bj')[0].style.display = 'none'
            $('#sb')[0].style.display = 'block'
            // $('.dispatch')[0].style.display = 'none'

        })
        //打开
        $('#open').click(function () {
            $('#wu')[0].style.display = 'block'
            $('#icamera_button')[0].style.display = 'block'
        })
        //关闭
        // function(){
        //
        // }
        $('#close').click(function () {
            $('#wu')[0].style.display = 'none'
            $('#icamera_button')[0].style.display = 'none'
            $('#carPng')[0].style.display='block'
            playr.stop()
        })
        //
        // $('#over').click(function () {
        //     $('.plc')[0].style.display = 'block'
        //     $('.caozuo_right')[0].style.display = 'block'
        //     $('.pmcz')[0].style.display = 'block'
        //
        //
        // })
        // $('#start').click(function () {
        //     $('.plc')[0].style.display = 'none'
        //     $('.caozuo_right')[0].style.display = 'none'
        //     $('.pmcz')[0].style.display = 'none'
        //
        //
        // })
        $('#over').click(function () {
            // $('.plc')[0].style.display = 'block'
            // $('.caozuo_right')[0].style.display = 'block'
            // $('.pmcz')[0].style.display = 'block'


            $('#direction')[0].style.display = 'block'
            $('#direction')[0].style.display = 'flex'

            $('#inching')[0].style.display = 'block'
            $('#inching')[0].style.display = 'flex'

            $('#screen')[0].style.display = 'block'
            $('#screen')[0].style.display = 'flex'

            $('.plc')[0].style.display = 'block'
            $('#plc')[0].style.display = 'flex'

            $('#hj')[0].style.display = 'none'
            // $('#hj')[0].style.display = 'flex'


        })
        $('#start').click(function () {
            // $('.plc')[0].style.display = 'none'
            // $('.caozuo_right')[0].style.display = 'none'
            // $('.pmcz')[0].style.display = 'none'


            $('#direction')[0].style.display = 'none'
            $('#inching')[0].style.display = 'none'
            $('#screen')[0].style.display = 'none'
            $('.plc')[0].style.display = 'none'
            $('#hj')[0].style.display = 'block'
            $('#hj')[0].style.display = 'flex'



        })


        $('#cleanOn').click(function () {
        $('#cleanOn').attr("style", "background-color: #11cb28;color:#ffffff;");
        ykzz('捡垃圾开');
        $('#cleanOff').attr("style", "background-color: #ffffff;color:#000000;");
    })

    $('#cleanOff').click(function () {
        // $('.plc')[0].style.display = 'none'
        // $('.caozuo_right')[0].style.display = 'none'
        // $('.pmcz')[0].style.display = 'none'


        $('#cleanOff').attr("style", "background-color: #11cb28;color:#ffffff;");
        ykzz('捡垃圾关');
        $('#cleanOn').attr("style", "background-color: #ffffff;color:#000000;");


    })






        $('#vb').click(function () {
            var obj = document.getElementById('highsel')
            var selectOptions = obj.options;
            var optionLength = selectOptions.length;
            for (var i = 0; i < optionLength; i++) {
                obj.removeChild(selectOptions[0]);
            }
            var obj2 = document.getElementById('lcz')
            var selectOptions2 = obj2.options;
            var optionLength2 = selectOptions2.length;
            for (var i = 0; i < optionLength2; i++) {
                obj2.removeChild(selectOptions2[0]);
            }

            getrw();
        })
        $('.dispatch').click(function () {
            // $('#wu')[0].style.display = 'block'
            // $('#icamera_button')[0].style.display = 'block'

            $('#open')[0].style.backgroundColor = '#11cb28'

            $('#open')[0].style.color = '#ffffff'
            $('#close')[0].style.backgroundColor = '#ffffff'
            $('#close')[0].style.color = 'black'
            $('.zprw')[0].style.display = 'block'





        })
        $('.cf').click(function () {


        })
        $('#nrqx').click(function () {
            $('.nrdq')[0].style.display = 'none'

        })
        $('.qx').click(function () {
            $('.zprw')[0].style.display = 'none'
            // var highse = document.getElementById('highsel')
            // var h = document.getElementsByTagName('option')
            //

            // highse.remove(h)

        })
        $('.qx2').click(function () {
            $('.qxrw')[0].style.display = 'none'

        })
        $('#drdq').click(function () {
        var jdData = {};
        jdData["shebeinum"] = document.getElementById('number').innerHTML
        var key = tool.randomWord(false, 32);
        var keyname = tool.getNowRan();
        sessionStorage.setItem(keyname, key);
        var enKey = rsa.Encrypt(key);
        var parm = JSON.stringify(jdData);
        var sign = faultylabs.MD5(parm + key);
        parm = tool.base64Encode(parm);
        parm = aes.Encrypt(parm, key);
        var jsonData = {"id": keyname, "key": enKey, "data": parm, "sign": sign };
        jsonData =JSON.stringify(jsonData);
        $.ajax({
            url:  "/api/system/hyJqrdt?methodname=getScreenWords&rnd=" + Math.random(),
            type: 'POST',
            async: false,
            contentType: 'application/json',
            dataType: "json",
            data: jsonData,
            success: function(res) {
                var result;
                if (res.id == '0') {
                    sessionStorage.removeItem(keyname);
                    var data = tool.base64Decode(res.data);
                    result = JSON.parse(tool.unicodeDecode(data));
                } else {
                    var key = sessionStorage.getItem(res.id);
                    if (key == null) {
                        alert('系统密钥维护中，请稍后处理');
                        return false;
                    }
                    sessionStorage.removeItem(res.id);
                    var data = tool.base64Decode(aes.Decrypt(res.data, key));
                    data = tool.utf8to16(data);
                    var md5 = faultylabs.MD5(data + key);
                    if (md5 !== res.key) {
                        alert('系统签名维护中，请稍后处理');
                        return false;
                    }
                    result = JSON.parse(tool.unicodeDecode(data));
                }
                if (result.screenWords != undefined) {
                    document.getElementById('textarea').value = result.screenWords;
                }
            },
            error: function(data) {}
        });
            $('.nrdq')[0].style.display = 'block'
            console.log(123)
        })
        //当前日期

        var t = null
        t = setTimeout(time, 1000);
        function time() {
            clearTimeout(t);
            dt = new Date()
            var y = dt.getFullYear()
            var M = dt.getMonth() + 1
            var d = dt.getDate()
            var h = dt.getHours()
            var m = dt.getMinutes()
            var s = dt.getSeconds()
            if (s < 10) {
                s = '0' + s
            }
            if (m < 10) {
                m = '0' + m
            }
            if (h < 10) {
                h = '0' + h
            }
            if (M < 10) {
                M = '0' + M
            }
            if (d < 10) {
                d = '0' + d
            }
            var dates = y + '年' + M + '月' + d + '日' + '&nbsp;' + h + ':' + m + ':' + s
            var caokong = '<span>' + dates + '</span>'
            $('#dates')[0].innerHTML = caokong
            t = setTimeout(time, 1000)

        }


        (function () {
            // this.getEvent()
            // clearInterval(this.gE)
            // loadsj3()
            getEvent()
            // setInterval(function(){
            //        getEvent()
            //    },5000)

        })()

        function tj() {
            nrdq()
            $('.nrdq')[0].style.display = 'none'

        }
        function nrdq() {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["cmd"] = document.getElementById('textarea').value;
            jdData["cmdType"] = cmdType;
            jdData["shebeinum"] = document.getElementById('number').innerHTML
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getpmzl&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    token = result.data;
                    console.log(result.code)

                    if (code == 0) {
                        layer.msg(msg);
                    } else {
                        layer.msg(msg);
                    }
                },
                error: function (data) { }
            });
        }

        var token;
        gettoken();
        var flag = 0;
        //获取token
        function gettoken() {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getsxttoken&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    token = result.data;
                    // console.log(result.data)

                },
                error: function (data) { }
            });
        }

        //打开
        // $('#open').click(function () {
        //     $('#wu')[0].style.display = 'block'
        // })
        //关闭
        $('#close').click(function () {
            $('#wu')[0].style.display = 'none'
        })

        console.log($('#videoId')[0].innerHTML)
        //摄像头地址
        function dksxt(videoNumber) {
            $('#wu').html('')
        $('#wu')[0].style.display = 'block'
        $('#carPng')[0].style.display= 'none'
        $('#icamera_button')[0].style.display = 'block'
        fetch('https://open.ys7.com/jssdk/ezopen/demo/token')
        .then(response => response.json())
        .then(res => {
                // var accessToken = res.data.accessToken;
                // var accessToken = 'at.dwnsz4ahc2yg62y7b3rod5bh95ubq4p7-968snlc511-16vjze1-kfthohnl0';//res.data.accessToken;
                playr = new EZUIKit.EZUIKitPlayer({
                id: 'wu', // 视频容器ID
                accessToken: token,
                url: `ezopen://open.ys7.com/${videoNumber}/1.live`,
                template: 'security', // simple - 极简版;standard-标准版;security - 安防版(预览回放);voice-语音版; theme-可配置主题；
                plugin: ['talk'],                       // 加载插件，talk-对讲
                width: 600,
                height: 400,
            });
        });
            //$('#icamera').attr('src', 'https://open.ys7.com/ezopen/h5/iframe_se?bSupporDoubleClickFull=0&url=ezopen://open.ys7.com/' + videoNumber + '/1.live&autoplay=1&audio=1&accessToken=' + token + '&templete=0&id=video-container');
        }
        //摄像头全屏
        function qpsxt(videoNumber) {
            window.open('https://open.ys7.com/ezopen/h5/iframe_se?bSupporDoubleClickFull=0&url=ezopen://open.ys7.com/' + videoNumber + '/1.live&autoplay=1&audio=1&accessToken=' + token + '&templete=0&id=video-container')
        }




        //操作切换
        var Switch = $('#sbck div:nth-child(n+2)')
        for (var i = 0; i < Switch.length; i++) {
            Switch[i].addEventListener('click', function () {
                for (var i = 0; i < Switch.length; i++) {
                    Switch[i].style.backgroundColor = '#ffffff'
                    // Switch[i].style.border = '1px solid #ffffff'
                    Switch[i].style.color = 'black'

                }
                console.log(123)
                this.style.backgroundColor = '#11cb28'
                // this.style.border = '1px solid #11cb28'
                this.style.color = '#ffffff '


            })
        }
        // $(function(){
        //     $("#over").addClass("mou");
        // });
        //
        // function yangshi() {
        //     $('#over').addClass('mou')
        //     console.log('qwe')
        // }



        var Direction = $('#direction div:nth-child(n+2)')
        for (var i = 0; i < Direction.length; i++) {
            Direction[i].addEventListener('click', function () {
                for (var i = 0; i < Direction.length; i++) {
                    Direction[i].style.backgroundColor = '#ffffff'
                    Direction[i].style.color = 'black'

                }
                this.style.backgroundColor = '#11cb28'
                this.style.color = '#ffffff'

            })
        }

        var Screen = $('#screen div:nth-child(n+2)')
        for (var i = 0; i < Screen.length; i++) {
            Screen[i].addEventListener('click', function () {
                for (var i = 0; i < Screen.length; i++) {
                    Screen[i].style.backgroundColor = '#ffffff'
                    Screen[i].style.color = 'black'

                }
                this.style.backgroundColor = '#11cb28'
                this.style.color = '#ffffff'

            })
        }

        var Probe = $('#probe div:nth-child(n+2)')
        for (var i = 0; i < Probe.length; i++) {
            Probe[i].addEventListener('click', function () {
                for (var i = 0; i < Probe.length; i++) {
                    Probe[i].style.color = 'black'
                    Probe[i].style.backgroundColor = '#ffffff'

                }
                this.style.backgroundColor = '#11cb28'
                this.style.color = '#ffffff'

            })
        }

        var Inching = $('#inching div:nth-child(n+2)')
        for (var i = 0; i < Inching.length; i++) {
            Inching[i].addEventListener('click', function () {
                for (var i = 0; i < Inching.length; i++) {
                    Inching[i].style.color = 'black'

                    Inching[i].style.backgroundColor = '#ffffff'
                }
                this.style.backgroundColor = '#11cb28'
                this.style.color = '#ffffff'

            })
        }
        var SetUp = $('#setUp div:nth-child(n+1)')
        for (var i = 0; i < SetUp.length; i++) {
            SetUp[i].addEventListener('click', function () {
                // for (var i = 0;i<SetUp.length;i++){
                //     SetUp[i].style.backgroundColor = '#ffffff'
                // }
                this.style.backgroundColor = '#11cb28'
                this.style.color = '#ffffff'

            })
        }
        var hj = $('#hj div:nth-child(n+1)')
        for (var i = 0; i < hj.length; i++) {
            hj[i].addEventListener('click', function () {
                for (var i = 0; i < hj.length; i++) {
                    hj[i].style.backgroundColor = '#ffffff'
                }
                this.style.backgroundColor = '#11cb28'
                this.style.color = '#ffffff'

            })
        }

        var Plccz = $('#plc div:nth-child(n+1)')
        for (var i = 0; i < Plccz.length; i++) {
            Plccz[i].addEventListener('click', function () {
                for (var i = 0; i < Plccz.length; i++) {
                    Plccz[i].style.backgroundColor = '#ffffff'
                    Plccz[i].style.color = 'black'

                }
                this.style.backgroundColor = '#11cb28'
                this.style.color = '#ffffff'

            })
        }






















        //----------------------------------
        //操作切换

        // $(function(){
        //     $("#over").addClass("mou");
        // });
        //
        // function yangshi() {
        //     $('#over').addClass('mou')
        //     console.log('qwe')
        // }







        //    =============================================================================================

        // var infoWindowContent ='';
        var infoWindow;
        var lnglat = [120.694198, 30.082796];
        var cluster, markers = [];
        var count = "";
        var dd = [];

        var scale = new AMap.Scale({
            visible: true
        }),
            toolBar = new AMap.ToolBar({
                visible: true
            }),
            marker, map = new AMap.Map('container', {
                resizeEnable: true, //是否监控地图容器尺寸变化
                zoom: 11, //初始化地图层级
                //center:[121.701589,29.766442] ,
                center: [120.694198, 30.082796],//初始化地图中心点
                mapStyle: "amap://styles/e8c13058c1c1024f7f90ffa50b07a3c1"
            });
        map.addControl(scale);
        map.addControl(toolBar);
        map.setFitView();
        function showInfoDragend() {
            document.getElementById("xx").innerHTML = "";
        }
        map.on('complete', function () {
            loadsj2();
            loadsj();
            setInterval((ele, index) => {
                loadsj();
            }, 1000 * 30);
            map.on('dragend', showInfoDragend);
            map.on('click', showInfoDragend);
            //map.setFitView();
        });
        var token;
        gettoken();

        var menu = new ContextMenu(map);
        var deriction = 15;
        var type = 0;

        //自定义菜单类
        function ContextMenu(map) {
            var me = this;

            //地图中添加鼠标工具MouseTool插件
            this.mouseTool = new AMap.MouseTool(map);

            this.contextMenuPositon = null;

            var content = [];

            content.push("<div class='info context_menu'>");
            content.push("  <p onclick='menu.addMarkerMenu()'>指派任务</p>");
            content.push("</div>");

            //通过content自定义右键菜单内容
            this.contextMenu = new AMap.ContextMenu({ isCustom: true, content: content.join('') });

            //地图绑定鼠标右击事件——弹出右键菜单
            map.on('rightclick', function (e) {
                me.contextMenu.open(map, e.lnglat);
                me.contextMenuPositon = e.lnglat; //右键菜单位置
            });
        }

        ContextMenu.prototype.addMarkerMenu = function () {  //右键菜单添加Marker标记
            this.mouseTool.close();
            getrw(this.contextMenuPositon);
            map.setZoomAndCenter(11, [this.contextMenuPositon.lng, this.contextMenuPositon.lat]);
            // var marker = new AMap.Marker({
            // 	map: map,
            // 	position: this.contextMenuPositon //基点位置
            // });


            this.contextMenu.close();
        };

        function qx() {
            infoWindow.close();
        }

        var qwe;


        function getrw() {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getGaoshuType&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    qwe = result.data[0].highwayname
                    // var str="<option>请选择</option>";
                    var lcz = document.getElementById('lcz')
                    var o2 = document.createElement('option')
                    lcz.append(o2)
                    o2.innerHTML = '请选择'
                    var h = document.getElementById('highsel')
                    var o = document.createElement('option')
                    h.append(o)
                    o.innerHTML = '请选择'
                    var pmnr = document.getElementById('pmnr')
                    var o3 = document.createElement('option')
                    pmnr.append(o3)
                    o3.innerHTML = '请选择'
                    $.each(result.data, function (i) {
                        // console.log(this.highwayname);
                        // $('#highsel').append(new Option(this.highwayname,this.highwayname));// 下拉菜单里添加元素
                        var str = this.highwayname;
                        var highse = document.getElementById('highsel')
                        var option = document.createElement('option')
                        highse.append(option)
                        option.innerHTML = str
                    });
                    // $.each(result.data2, function (i) {
                    //     // console.log(this.highwayname);
                    //     // $('#highsel').append(new Option(this.highwayname,this.highwayname));// 下拉菜单里添加元素
                    //     var str2=this.typename;
                    //     console.log(str2)
                    //     var lcz2 = document.getElementById('lcz')
                    //     var option2 = document.createElement('option')
                    //     lcz2.append(option2)
                    //     option2.innerHTML = str2
                    // });
                    $.each(result.data3, function (i) {
                        // console.log(this.highwayname);
                        // $('#highsel').append(new Option(this.highwayname,this.highwayname));// 下拉菜单里添加元素
                        var str3 = this.typename;
                        console.log(str3)
                        var pmnr2 = document.getElementById('pmnr')
                        var option3 = document.createElement('option')
                        pmnr2.append(option3)
                        option3.innerHTML = str3
                    });

                },
                error: function (data) { }
            });
        }


        function getEvent() {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getEvent&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    console.log(result.data.length)
                    // var e = document.getElementById('iop')
                    // var f =   e.getElementsByTagName('tr')
                    // for (i = 0;i<=f.length;i++){
                    //     console.log(i)
                    // }
                    var table = document.getElementById("iop");
                    var tableLength = table.rows.length;
                    for (var int = 2; int < tableLength + 1; int++) {
                        table.deleteRow(1);
                    }
                    var data2 = [];
                    for (var i = 0; i < result.data.length; i++) {
                        // var data1 = {};
                        // data1.num = result.data[i].eventTime;
                        // data1.name = result.data[i].lcz;
                        // data1.tt = result.data[i].shebeiId;
                        // data1.ck = result.data[i].highwayname;
                        // data1.bk = result.data[i].direction;
                        // data1.type = '管理员';
                        // data2.push(data1);


                        var data1 = {};
                        var kssj = result.data[i].eventTime;

                        var Zkssj = formatDate(kssj)
                        data1.num = Zkssj;
                        var dqsjc = Date.now()
                        var dq = dqsjc - kssj
                        var l = toHHmmss(dq)
                        data1.timeLength = l;
                        data1.name = result.data[i].lcz;
                        data1.tt = result.data[i].shebeiId;
                        data1.ck = result.data[i].highwayname;
                        data1.bk = result.data[i].direction;
                        data1.qx = '取消任务';
                        data1.type = '查看';
                        data2.push(data1);
                    }


                    for (var i = 0; i < data2.length; i++) {
                        var tr = document.createElement("tr");
                        table.appendChild(tr);
                        tr.onclick = function () {
                            var e = $(this).children('td')[3].innerHTML
                            // this.style.backgroundColor = '#9b2727'
                            loadsj3(e)
                            loadsj10(e)

                        };


                        for (var k in data2[i]) {
                            var td = document.createElement("td");
                            tr.appendChild(td);
                            td.innerHTML = data2[i][k];
                        }
                        var ck = tr.children[7]
                        ck.onclick = function () {
                            $('#bj')[0].style.display = 'none'
                            $('#sb')[0].style.display = 'block'
                            $('#zprw')[0].style.display = 'none'

                        }
                        var qx = tr.children[6]
                        qx.onclick = function () {
                            $('.qxrw')[0].style.display = 'block'
                            //-----
                            var obj = document.getElementById('highsell')
                            var selectOptions = obj.options;
                            var optionLength = selectOptions.length;
                            for (var i = 0; i < optionLength; i++) {
                                obj.removeChild(selectOptions[0]);
                            }
                            var obj2 = document.getElementById('lczz')
                            var selectOptions2 = obj2.options;
                            var optionLength2 = selectOptions2.length;
                            for (var i = 0; i < optionLength2; i++) {
                                obj2.removeChild(selectOptions2[0]);
                            }
                            qxcf()

                        }
                    }


                },
                error: function (data) { }
            });
        }

        $(document).on('change', '#highsell', function () {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["selected"] = $("#highsell").find("option:selected").text();
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getSubGoasu&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    console.log(result.data);
                    $('#subhighh').empty();
                    $('#subhighh').append(new Option('请选择', '请选择'));
                    $.each(result.data, function (i) {
                        $('#subhighh').append(new Option(this.subhigh, this.subhigh));// 下拉菜单里添加元素

                    });
                },
                error: function (data) { }
            });

        });
        $(document).on('change', '#subhighh', function () {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["selected"] = $("#subhighh").find("option:selected").text();
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getGaoshuType2&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    console.log(result.data);
                    $('#lczz').empty();
                    $('#lczz').append(new Option('请选择', '请选择'));
                    $.each(result.data, function (i) {
                        // console.log(this.highwayname);
                        // $('#highsel').append(new Option(this.highwayname,this.highwayname));// 下拉菜单里添加元素
                        var str2 = this.typename;
                        console.log(str2)
                        var lcz2 = document.getElementById('lczz')
                        var option2 = document.createElement('option')
                        lcz2.append(option2)
                        option2.innerHTML = str2
                    });
                },
                error: function (data) { }
            });

        });
        $(document).on('change', '#lczz', function () {
            console.log();
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["selected"] = $("#subhighh").find("option:selected").text();
            jdData["lcz"] = $("#lczz").find("option:selected").text();
            // jdData["lon"] = $("#jd").val();
            // jdData["lat"] = $("#wd").val();
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getSbMsg&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    $('#sbxhh').text('');
                    $('#sbxhh').text(result.data.deviceNo);
                    $('#sbxhh').val(result.data.deviceNo);
                },
                error: function (data) { }
            });
        });

        function qxcf() {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getGaoshuType&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    qwe = result.data[0].highwayname
                    console.log(result)
                    var lcz = document.getElementById('lczz')
                    var o2 = document.createElement('option')
                    lcz.append(o2)
                    o2.innerHTML = '请选择'
                    var h = document.getElementById('highsell')
                    var o = document.createElement('option')
                    h.append(o)
                    o.innerHTML = '请选择'

                    $.each(result.data, function (i) {
                        // console.log(this.highwayname);
                        // $('#highsel').append(new Option(this.highwayname,this.highwayname));// 下拉菜单里添加元素
                        var str = this.highwayname;
                        var highse = document.getElementById('highsell')
                        var option = document.createElement('option')
                        highse.append(option)
                        option.innerHTML = str
                    });
                    //abcd//

                    // $.each(result.data2, function (i) {
                    //     // console.log(this.highwayname);
                    //     // $('#highsel').append(new Option(this.highwayname,this.highwayname));// 下拉菜单里添加元素
                    //     var str2=this.typename;
                    //     var lcz2 = document.getElementById('lczz')
                    //     var option2 = document.createElement('option')
                    //     lcz2.append(option2)
                    //     option2.innerHTML = str2
                    // });

                },
                error: function (data) { }
            });
        }
        function loadsj10(e) {

            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                // url:  "/api/system/hyJqrdt?methodname=getPoint&rnd=" + Math.random(),
                url: "/api/system/hyJqrdt?methodname=getEvent&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    console.log(result.data)
                    //有数据===============================================================================================================================
                    var sbzt = "充电中";
                    if (result.data.devicestatus == 1) {
                        sbzt = "作业中";
                    } else if (result.data.devicestatus == 2) {
                        sbzt = "工作中";
                    }


                    for (var i = 0; i < result.data.length; i++) {

                        if (e === result.data[i].shebeiId) {
                            document.getElementById('highsell').options[1] = new Option(result.data[i].highwayname, result.data[i].highwayname);
                            document.getElementById('highsell').options[1].selected = true
                            var Subhighh = document.getElementById('subhighh');
                            var index = Subhighh.selectedIndex;
                            Subhighh.options[index] = new Option(result.data[i].direction, result.data[i].direction);
                            Subhighh.options[index].selected = true



                            document.getElementById('lczz').options[0] = new Option(result.data[i].lcz, result.data[i].lcz);
                            document.getElementById('lczz').options[0].selected = true
                            // if (e === '002') {
                            //     document.getElementById('lczz').options[2] = new Option(result.data[i].lcz, result.data[i].lcz);
                            //     document.getElementById('lczz').options[2].selected = true
                            // }
                            // else {
                            //     document.getElementById('lczz').options[1] = new Option(result.data[i].lcz, result.data[i].lcz);
                            //     document.getElementById('lczz').options[1].selected = true
                            // }

                            var Sbxhh = document.getElementById('sbxhh');
                            Sbxhh.innerHTML = result.data[i].shebeiId

                        }

                    }
                },
                error: function (data) { }
            });

        }



        var tou;
        function loadsj3(e) {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getPoint&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    //有数据===============================================================================================================================
                    var sbzt = "充电中";
                    if (result.data.devicestatus == 1) {
                        sbzt = "作业中";
                    } else if (result.data.devicestatus == 2) {
                        sbzt = "工作中";
                    }
                    // 设置点标记的动画效果，此处为弹跳效果
                    console.log('2222222222222222222222222xxxxxxxxxxxxxxxxxx')
                    // document.getElementById("sb").style.display = "block"
                    // document.getElementById("bj").style.display = "none"
                    // document.getElementById("zprw").style.display = "none"

                    for (var i = 0; i < result.data.length; i++) {
                        if (e == result.data[i].deviceno) {
                            console.log(result.data[i])
                            document.getElementById("number").innerText = result.data[i].deviceno
                            document.getElementById("state").innerText = sbzt
                            document.getElementById("fangxiang").innerText = result.data[i].direction
                            document.getElementById("videoId").innerText = result.data[i].videomsg
                            document.getElementById("bfb").innerText = parseInt(result.data[i].dl * 100) + "%"
                            document.getElementById("lon").innerText = result.data[i].lon
                            document.getElementById("lat").innerText = result.data[i].lat
                            videoNumber = result.data[i].videomsg

                        }
                    }
                },
                error: function (data) { }
            });
        }

        //时分秒
        function toHHmmss(e) {
            var secondTime = (e / 1000).toFixed(0);// 秒
            var minuteTime = 0;// 分
            var hourTime = 0;// 小时
            if (secondTime > 60) {
                minuteTime = parseInt(secondTime / 60);
                secondTime = parseInt(secondTime % 60);
                if (minuteTime > 60) {
                    hourTime = parseInt(minuteTime / 60);
                    minuteTime = parseInt(minuteTime % 60);
                }
            }
            var result;
            if (secondTime < 10) {
                result = "" + '0' + parseInt(secondTime) + "秒";
            } else {
                result = "" + parseInt(secondTime) + "秒";

            }
            if (minuteTime < 10) {
                result = "" + '0' + parseInt(minuteTime) + "分" + result;
            } else {
                result = "" + parseInt(minuteTime) + "分" + result;
            }
            if (hourTime < 10) {
                result = "" + '0' + parseInt(hourTime) + "小时" + result;
            } else {
                result = "" + parseInt(hourTime) + "小时" + result;

            }
            return result;

        }

        //年月日时分秒
        function formatDate(value) {
            if (typeof (value) == 'undefined') {
                return ''
            } else {
                var date = new Date(parseInt(value))
                var y = date.getFullYear()
                var MM = date.getMonth() + 1
                MM = MM < 10 ? ('0' + MM) : MM
                var d = date.getDate()
                d = d < 10 ? ('0' + d) : d
                var h = date.getHours()
                h = h < 10 ? ('0' + h) : h
                var m = date.getMinutes()
                m = m < 10 ? ('0' + m) : m
                var s = date.getSeconds()
                s = s < 10 ? ('0' + s) : s
                return y + '-' + MM + '-' + d + ' ' + h + ':' + m + ':' + s
            }
        }


        var markeron3 = []
        function cf() {
            if ($("#highsel").find("option:selected").text() == "请选择") {
                layer.msg('请选择高速名称');
            } else {
                if ($("#subhigh").find("option:selected").text() == "请选择") {
                    layer.msg('请选择车道方向');
                } else {
                    if ($("#lcz").find("option:selected").text() == "请选择") {
                        layer.msg('请选择里程桩');
                    } else {
                        if ($("#sbyx").find("option:selected").text() == "请选择") {
                            layer.msg('请选择设备运行方向');
                        } else {
                            var jdData = {};
                            jdData["hyuid"] = ls_uid;
                            jdData["gsmc"] = $("#highsel").find("option:selected").text();
                            jdData["cdfx"] = $("#subhigh").find("option:selected").text();
                            jdData["lcz"] = $("#lcz").find("option:selected").text();
                            jdData["jl"] = $('#jl').val();
                            jdData["nr"] = $('#pmnr').val();
                            jdData["shebeinum"] = $('#sbxh').val();
                            jdData["fx"] = $('#sbyx').find("option:selected").text();
                            var key = tool.randomWord(false, 32);
                            var keyname = tool.getNowRan();
                            sessionStorage.setItem(keyname, key);
                            var enKey = rsa.Encrypt(key);
                            var parm = JSON.stringify(jdData);
                            var sign = faultylabs.MD5(parm + key);
                            parm = tool.base64Encode(parm);
                            parm = aes.Encrypt(parm, key);
                            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
                            jsonData = JSON.stringify(jsonData);
                            $.ajax({
                                url: "/api/system/hyJqrdt?methodname=addevent&rnd=" + Math.random(),
                                type: 'POST',
                                async: false,
                                contentType: 'application/json',
                                dataType: "json",
                                data: jsonData,
                                success: function (res) {
                                    var result;
                                    if (res.id == '0') {
                                        sessionStorage.removeItem(keyname);
                                        var data = tool.base64Decode(res.data);
                                        result = JSON.parse(tool.unicodeDecode(data));
                                    } else {
                                        var key = sessionStorage.getItem(res.id);
                                        if (key == null) {
                                            alert('系统密钥维护中，请稍后处理');
                                            return false;
                                        }
                                        sessionStorage.removeItem(res.id);
                                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                                        data = tool.utf8to16(data);
                                        var md5 = faultylabs.MD5(data + key);
                                        if (md5 !== res.key) {
                                            alert('系统签名维护中，请稍后处理');
                                            return false;
                                        }
                                        result = JSON.parse(tool.unicodeDecode(data));
                                    }
                                    code = result.code;
                                    havesave = result.havesave;
                                    havedel = result.havedel;
                                    console.log(result.data)

                                    dd = result.data.dd;
                                    console.log(markeron2)
                                    for (var i = 0; i < markeron2.length; i++) {
                                        if (markeron2[i].Ce.extData.deviceno == $('#sbxh').val()) {
                                            markeron2[i].setMap(null);
                                        }
                                    }

                                    marker = new AMap.Marker({
                                        map: map,
                                        position: dd[1],
                                        icon: "../img/sb.png",
                                        offset: new AMap.Pixel(-13, -30),
                                        angle: 0,
                                    });
                                    markeron3.push(marker);
                                    console.log("=====1======");

                                    console.log(marker);

                                    marker.on('moving', function (e) {
                                        passedPolyline.setPath(e.passedPath);
                                    });
                                    map.setFitView();

                                    marker.moveAlong(dd, 100);
                                    marker.on('click', openInfo);

                                    function openInfo(e) {
                                        console.log(e)
                                        var data = e.target.getExtData();
                                        datashebei = e.target.getExtData();
                                        var sbzt = "充电中";
                                        if (result.data.data.devicestatus == 1) {
                                            sbzt = "作业中";
                                        } else if (result.data.data.devicestatus == 2) {
                                            sbzt = "工作中";
                                        }
                                        var infoWindowContent2 =
                                            '<div class="win1 pos1">' +
                                            ' <div class="box">' +
                                            ' <div class="c1"><div class="box-title huang">设备信息</div><div class="lat"></div></div>' +
                                            ' <div><span>设备编号:</span><span class="f20 fbold">' + result.data.data.deviceno + '</span></div>' +
                                            ' <div><span>摄像头编号:</span><span class="f20 fbold">' + result.data.data.videomsg + '</span></div>' +
                                            ' <div><span>初始坐标:</span><div id="csjd">' + result.data.data.lon + '</div>, <div id="cswd">' + result.data.data.lat + '</div></div>' +
                                            ' <div><span>当前坐标:</span><div id="dqjd">' + e.lnglat.lng + '</div>, <div id="dqwd">' + e.lnglat.lat + '</div></div>' +
                                            ' <div><span>设备方向:</span><span class="fbold">' + result.data.data.direction + '</span></div>' +
                                            ' <div><span>当前状态:</span><span class="fbold">' + sbzt + '</span></div>' +
                                            ' <div class="x1"></div>' +
                                            ' <div class="c1"><div class="box-title huang">手动操作</div><div class="lat"></div></div>' +
                                            ' <div><span>设备操控:</span><div class="btnrow"><button>开始遥控</button><button class="active">结束遥控</button></div></div>' +
                                            ' <div ><span>设备充电:</span><div class="btnrow"><button onclick="ykzz(\'充电\')">充电</button></div></div>' +
                                            ' <div ><span>方向操控:</span><div class="btnrow" ><button onclick="ykzz(\'向左\')">向左</button><button  onclick="ykzz(\'向右\')">向右</button><button onclick="ykzz(\'停止\')">停止</button></div></div>' +
                                            // ' <div><span>速度调节:</span><div class="btnrow"><button>速度一:20</button><button>速度二:5</button><button>速度三:0.9</button></div></div>'+
                                            '<span>屏幕操控:</span>' +
                                            ' <div ><div class="btnrow"><button onclick="ykzz(\'展开\')">展开</button><button onclick="ykzz(\'收回\')">收回</button></div></div>' +
                                            '<div><button onclick="ykzz(\'屏幕内容调取\')">屏幕内容调取</button></div>' +

                                            //' <div><span>返程操控:</span><div class="btnrow"><button onclick="fccz()">返程</button></div></div>'+
                                            ' <div ><span>返程操控:</span><div class="btnrow"><button onclick="ykzz(\'向左返程\')">向左返程</button><button onclick="ykzz(\'向右返程\')">向右返程</button></div></div>' +
                                            ' <div ><span>点动操控:</span><div class="btnrow"><button onclick="ykzz(\'向左点动\')">向左点动</button><button onclick="ykzz(\'向右点动\')">向右点动</button></div></div>' +
                                            ' <div ><span>摄像头操控:</span><div class="btnrow" onclick="dksxt()" ><button style="cursor:pointer">打开</button></div></div>' +
                                            '</div>' +
                                            '</div>';
                                        // //实例化信息窗体
                                        // var infoWindow2 = new AMap.InfoWindow({
                                        //     position: lnglat,
                                        //     isCustom: true,
                                        //     offset: new AMap.Pixel(0, -35),
                                        //     content: infoWindowContent2
                                        // });
                                        // infoWindow2.open(map, e.lnglat);

                                    }

                                    loadsj2();
                                    getEvent();
                                    $('.zprw')[0].style.display = 'none';
                                    console.log(dd);
                                    if (result.data.status == 0) {
                                        layer.msg(result.data.msg);
                                        infoWindow.close();
                                        // location.reload();
                                        // } else {
                                        layer.msg(result.data.msg);
                                    }
                                },
                                error: function (data) {

                                }
                            });
                        }
                    }
                }
            }
        }
        var datashebei
        var markeron2 = [];
        // menu.contextMenu.open(map, lnglat);
        function loadsj() {
            map.clearMap();
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getPoint&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    //有数据===============================================================================================================================
                    console.log(result.data)
                    markers = result.data;
                    markers.forEach(function (marker) {

                    });
                    var markers1 = [];
                    deviceDataList = [];
                    for (var i = 0; i < markers.length; i++) {
                        var icon = '../img/sb.png';
                        if (markers[i].lat != '' && markers[i].lon != '') {
                            var markeron = new AMap.Marker({
                                map: map,
                                icon: icon,
                                position: [parseFloat(markers[i].lon), parseFloat(markers[i].lat)],
                                offset: new AMap.Pixel(-13, -30),
                                extData: markers[i]
                            });
                            markeron2.push(markeron);
                            deviceDataList.push(markers[i]);
                            var className = 'iconjq';
                            // if(icon =='../html/img/img_56.png' || icon =='../html/img/img_55.png'){
                            // 	markeron.setAnimation('AMAP_ANIMATION_BOUNCE');
                            // }
                            markeron.on('click', openInfo);
                        }
                    }
                    openInfoFirst(markers)
                    // 设置点标记的动画效果，此处为弹跳效果
                    function openInfoFirst(Data) {

                        var data = Data.filter((ele, index) => {
                            if (cameraData) {
                                if (cameraData.id == ele.id) {
                                    return ele
                                }
                            } else if (index == 0) {
                                return ele
                            }
                        })[0];
                        if (init) {
                            map.setZoomAndCenter(11, [data.lon,data.lat]);
                            deviceDataList.forEach((item) => {
                            $("#numberSelector").append("<option value='" + item.deviceno + "'>" + item.deviceno + "</option>");
                        });
                         $("#numberSelector").change(function(){
                            var nowDevice = null;
                            markers.forEach((item)=> {
                                if (item.deviceno == $("#numberSelector").val()) {
                                    nowDevice = item;
                                }
                            });
                            if (nowDevice != null) {
                                cameraData = nowDevice;
                                datashebei = nowDevice;
                                map.setCenter([nowDevice.lon,nowDevice.lat]);
                                //map.setCenter([nowDevice.lon,nowDevice.lat]);
                                setDevice(nowDevice);
                                changeIcon(nowDevice.deviceno);
                            }
                            });
                            init = false;
                        }
                        datashebei = data;
                        changeIcon(data.deviceno);
                        // console.log(data)
                        var sbzt = "充电中";
                        if (data.devicestatus == 1) {
                            sbzt = "作业中";
                        } else if (data.devicestatus == 2) {
                            sbzt = "工作中";
                        }
                        console.log('2222222222222222222222222xxxxxxxxxxxxxxxxxx')
                        document.getElementById("sb").style.display = "block"
                        document.getElementById("bj").style.display = "none"
                        document.getElementById("zprw").style.display = "none"
                        document.getElementById("number").innerText = data.deviceno
                        document.getElementById("state").innerText = sbzt
                        document.getElementById("fangxiang").innerText = data.direction
                        document.getElementById("videoId").innerText = data.videomsg
                        if (data.moveStatus == 1) {
                            data.moveStatus = "向左"
                        } else if (data.moveStatus == 2) {
                            data.moveStatus = "向右"
                        } else if (data.moveStatus == 0) {
                            data.moveStatus = "停止"
                        }
                        if (data.screenStatus == 1) {
                            data.screenStatus = "展开"
                        } else if (data.screenStatus == 0) {
                            data.screenStatus = "关闭"
                        }
                        document.getElementById("moveStatus").innerText = data.moveStatus
                        document.getElementById("screenStatus").innerText = data.screenStatus
                        var sbfb = data.dl * 100 + "%"
                        var s = data.dl
                        document.getElementById("bfb").innerText = sbfb
                        $('#ssdl')[0].style.width = 170 * s + 'px'
                        // document.getElementById('ssdl').style.width = 10+'px'
                        document.getElementById("lon").innerText = data.lon
                        document.getElementById("lat").innerText = data.lat
                        videoNumber = data.videomsg
                        // //实例化信息窗体
                        // var infoWindow2 = new AMap.InfoWindow({
                        //     position: lnglat,
                        //     isCustom:true,
                        //     offset: new AMap.Pixel(0, -35),
                        //     content: infoWindowContent2
                        // });
                        // infoWindow2.open(map, e.lnglat);

                    }

                    function changeIcon(deviceno) {
                        var overlays = map.getAllOverlays("marker");
                        overlays.forEach((item) => {
                            var extdata = item.getExtData();
                            if (extdata.deviceno == deviceno) {
                                item.setIcon("../img/sb-onclick.png");
                            } else {
                                item.setIcon("../img/sb.png");
                         }
                    });
                    }

                    function setDevice(data) {
                        var sbzt = "充电中";
                        if (data.devicestatus == 1) {
                            sbzt = "作业中";
                        } else if (data.devicestatus == 2) {
                            sbzt = "工作中";
                        }
                        document.getElementById("sb").style.display = "block"
                        document.getElementById("bj").style.display = "none"
                        document.getElementById("zprw").style.display = "none"
                        document.getElementById("number").innerText = data.deviceno
                        document.getElementById("state").innerText = sbzt
                        document.getElementById("fangxiang").innerText = data.direction
                        document.getElementById("videoId").innerText = data.videomsg
                        if (data.moveStatus == 1) {
                            data.moveStatus = "向左"
                        } else if (data.moveStatus == 2) {
                            data.moveStatus = "向右"
                        } else if (data.moveStatus == 0) {
                            data.moveStatus = "停止"
                        }
                        if (data.screenStatus == 1) {
                            data.screenStatus = "展开"
                        } else if (data.screenStatus == 0) {
                            data.screenStatus = "关闭"
                        }
                        document.getElementById("moveStatus").innerText = data.moveStatus
                        document.getElementById("screenStatus").innerText = data.screenStatus
                        var sbfb = parseInt(data.dl * 100) + "%"
                        var s = data.dl
                        document.getElementById("bfb").innerText = sbfb
                        $('#ssdl')[0].style.width = 170 * s + 'px'
                        // document.getElementById('ssdl').style.width = 10+'px'
                        document.getElementById("lon").innerText = data.lon
                        document.getElementById("lat").innerText = data.lat
                        videoNumber = data.videomsg
                    }
                    function openInfo(e) {
                        var data = e.target.getExtData();
                        datashebei = e.target.getExtData();
                        cameraData = data
                        cameraDom = e
                        // console.log(data)
                        setDevice(data);
                        changeIcon(data.deviceno);
                        $('#numberSelector').val(data.deviceno);
                        // //实例化信息窗体
                        // var infoWindow2 = new AMap.InfoWindow({
                        //     position: lnglat,
                        //     isCustom:true,
                        //     offset: new AMap.Pixel(0, -35),
                        //     content: infoWindowContent2
                        // });
                        // infoWindow2.open(map, e.lnglat);

                    }

                    count = markers1.length;
                    var _renderClusterMarker = function (context) {
                        var factor = Math.pow(context.count / count, 1 / 18);
                        var div = document.createElement('div');
                        var Hue = 180 - factor * 180;
                        var bgColor = 'hsla(' + Hue + ',100%,50%,0.7)';
                        var fontColor = 'hsla(' + Hue + ',100%,20%,1)';
                        var borderColor = 'hsla(' + Hue + ',100%,40%,1)';
                        var shadowColor = 'hsla(' + Hue + ',100%,50%,1)';
                        div.style.backgroundColor = bgColor;
                        var size = Math.round(30 + Math.pow(context.count / count, 1 / 5) * 20);
                        div.style.width = div.style.height = size + 'px';
                        div.style.border = 'solid 1px ' + borderColor;
                        div.style.borderRadius = size / 2 + 'px';
                        div.style.boxShadow = '0 0 1px ' + shadowColor;
                        div.innerHTML = context.count;
                        div.style.lineHeight = size + 'px';
                        div.style.color = fontColor;
                        div.style.fontSize = '14px';
                        div.style.textAlign = 'center';
                        context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
                        context.marker.setContent(div)
                    };

                },
                error: function (data) { }
            });
        }
        // $('#ssdl')[0].style.width = 10+'px'

        var cmd = '0106001100151800'
        var cmdType = '0'

        var flag = 0;


        function loadsj2() {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getEvent&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    console.log(result.data)
                    markers = result.data;
                    var markers1 = [];
                    markers.forEach(function (marker) {

                    });
                    for (var i = 0; i < markers.length; i++) {
                        var icon = '../img/sj.png';
                        if (markers[i].lat != '' && markers[i].lon != '') {
                            var markeron = new AMap.Marker({
                                map: map,
                                icon: icon,
                                position: [parseFloat(markers[i].lon), parseFloat(markers[i].lat)],
                                offset: new AMap.Pixel(-13, -30),
                                extData: markers[i]
                            });
                            var className = 'iconjq';
                            // if(icon =='../html/img/img_56.png' || icon =='../html/img/img_55.png'){
                            // 	markeron.setAnimation('AMAP_ANIMATION_BOUNCE');
                            // }
                        }
                    }
                    // 设置点标记的动画效果，此处为弹跳效果




                    count = markers1.length;
                    var _renderClusterMarker = function (context) {
                        var factor = Math.pow(context.count / count, 1 / 18);
                        var div = document.createElement('div');
                        var Hue = 180 - factor * 180;
                        var bgColor = 'hsla(' + Hue + ',100%,50%,0.7)';
                        var fontColor = 'hsla(' + Hue + ',100%,20%,1)';
                        var borderColor = 'hsla(' + Hue + ',100%,40%,1)';
                        var shadowColor = 'hsla(' + Hue + ',100%,50%,1)';
                        div.style.backgroundColor = bgColor;
                        var size = Math.round(30 + Math.pow(context.count / count, 1 / 5) * 20);
                        div.style.width = div.style.height = size + 'px';
                        div.style.border = 'solid 1px ' + borderColor;
                        div.style.borderRadius = size / 2 + 'px';
                        div.style.boxShadow = '0 0 1px ' + shadowColor;
                        div.innerHTML = context.count;
                        div.style.lineHeight = size + 'px';
                        div.style.color = fontColor;
                        div.style.fontSize = '14px';
                        div.style.textAlign = 'center';
                        context.marker.setOffset(new AMap.Pixel(-size / 2, -size / 2));
                        context.marker.setContent(div)
                    };

                },
                error: function (data) { }
            });
        }
        $(document).on('change', '#highsel', function () {
            console.log();
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["selected"] = $("#highsel").find("option:selected").text();
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getSubGoasu&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    console.log(result.data);
                    $('#subhigh').empty();
                    $('#subhigh').append(new Option('请选择', '请选择'));
                    $.each(result.data, function (i) {
                        $('#subhigh').append(new Option(this.subhigh, this.subhigh));// 下拉菜单里添加元素

                    });
                },
                error: function (data) { }
            });
        });
        $(document).on('change', '#subhigh', function () {
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["selected"] = $("#subhigh").find("option:selected").text();
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getGaoshuType2&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    $('#lcz').empty();
                    $('#lcz').append(new Option('请选择', '请选择'));
                    $.each(result.data, function (i) {
                        // console.log(this.highwayname);
                        // $('#highsel').append(new Option(this.highwayname,this.highwayname));// 下拉菜单里添加元素
                        var str2 = this.typename;
                        console.log(str2)
                        var lcz2 = document.getElementById('lcz')
                        var option2 = document.createElement('option')
                        lcz2.append(option2)
                        option2.innerHTML = str2
                    });
                },
                error: function (data) { }
            });

        });
        $(document).on('change', '#lcz', function () {
            console.log();
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["selected"] = $("#subhigh").find("option:selected").text();
            jdData["lcz"] = $("#lcz").find("option:selected").text();
            // jdData["lon"] = $("#jd").val();
            // jdData["lat"] = $("#wd").val();
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getSbMsg&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    $('#sbxh').text('');
                    $('#sbxh').text(result.data.deviceNo);
                    $('#sbxh').val(result.data.deviceNo);
                },
                error: function (data) { }
            });
        });
        function enterht() {
            window.location.href = '/web/system/index.html'
        }
        function ykzz(str) {

            if (str == "向左") {
                cmd = '01060011000B9808';
            }
            else if (str == "向右") {
                cmd = '0106001100151800';
            }
            else if (str == "停止") {
                cmd = '01060011000A59C8'
            }
            else if (str == "展开") {
                cmd = '01060011000519CC';
            }
            else if (str == "回收") {
                cmd = '01060011000659CD';
            } else if (str == "向左点动") {
                cmd = '01060011000D180A';
            } else if (str == "向右点动") {
                cmd = '01060011000E580B';
            }
            else if (str == "向左返程") {
                cmd = '01060011000CD9CA';
            }
            else if (str == "向右返程") {
                cmd = '0106001100165801';
            }
            else if (str == "充电") {
                cmd = '01060011000919C9';
            }
            else if (str == "结束充电") {
                cmd = '0106001100FF998F';
            }
            else if (str == "远程操控") {
                cmd = '64050015FF00940B';
            }
            else if (str == "亮屏") {
                cmd = '0106001100191805';
            }
            else if (str == "熄屏") {
                cmd = '01060011001A5804';
            }
            else if (str == "手动遥控") {
                cmd = '640500150000D5FB';
            } else if (str == "返程") {
                cmd = '返程';
            }
            else if (str == "关闭报警") {
            cmd = "01060011001B99C4";
            } else if (str == "打开报警") {
            cmd = "01060011001D19C6";
            }
            else if (str == "绿篱开") {
            cmd = "0106001100191805";
        }
        else if (str == "绿篱关") {
            cmd = "01060011001A5804";
        }
        else if (str == "捡垃圾开") {
            cmd = "01060101000399F7";
        }
        else if (str == "捡垃圾关") {
            cmd = "010601010000D9F6";
        }

            var jdData = {};
            jdData["cmd"] = cmd;
            jdData["cmdType"] = cmdType;
            jdData["shebeinum"] = document.getElementById('number').innerHTML
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getjqrzl&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }

                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;
                    msg = result.msg;
                    havesave = result.havesave;
                    havedel = result.havedel;
                    token = result.data;
                    console.log(result.code)

                    if (code == 0) {
                        layer.msg(msg);
                    } else {
                        layer.msg(msg);
                    }
                },
                error: function (data) { }
            });
        }
        function ytfx(str) {
            if (str == "向上") {
                type = 0;
                deriction = 0;
            } else if (str == "向下") {
                type = 0;
                deriction = 1;
            } else if (str == "向左") {
                type = 0;
                deriction = 2;
            } else if (str == "向右") {
                type = 0;
                deriction = 3;
            } else if (str == "停止") {
                type = 1;
                if (deriction == 15) {
                    layer.msg('设备暂未控制云台方向,请先选择方向');
                    return;
                }
                deriction == 15
            } else if (str == "语音对讲") {
                //navigator.mediaDevices.getUserMedia({ audio: true }).then((mediaStream) => {
                if($('#yydj').hasClass('yydj_open')) {
                    ykzz("打开报警");
                    playr.stopTalk()
                    $("#yydj").removeClass("yydj_open");
                    $("#yydj").css("color","#000000");
                    $("#yydj").css("background-color","#e9eeef");
                    console.log('关闭')
                }else{
                    ykzz("关闭报警");
                    playr.startTalk()
                    $("#yydj").addClass("yydj_open");
                    $("#yydj").css("color","#ffffff");
                    $("#yydj").css("background-color","rgb(17, 203, 40)");
                    console.log('开启')
                }

                //}).catch((error) => {
                //ykzz("打开报警");
                //$("#yydj").removeClass("yydj_open");
                //$("#yydj").css("color","#000000");
                //$("#yydj").css("background-color","#e9eeef");
                //playr.stopTalk()
                //console.log('关闭')
                //})
                return;
            }
            var jdData = {};
            jdData["hyuid"] = ls_uid;
            jdData["deriction"] = deriction;
            jdData["type"] = type;
            jdData["deviceSerial"] = document.getElementById('videoId').innerHTML;
            var key = tool.randomWord(false, 32);
            var keyname = tool.getNowRan();
            sessionStorage.setItem(keyname, key);
            var enKey = rsa.Encrypt(key);
            var parm = JSON.stringify(jdData);
            var sign = faultylabs.MD5(parm + key);
            parm = tool.base64Encode(parm);
            parm = aes.Encrypt(parm, key);
            var jsonData = { "id": keyname, "key": enKey, "data": parm, "sign": sign };
            jsonData = JSON.stringify(jsonData);
            $.ajax({
                url: "/api/system/hyJqrdt?methodname=getsxtfx&rnd=" + Math.random(),
                type: 'POST',
                async: false,
                contentType: 'application/json',
                dataType: "json",
                data: jsonData,
                success: function (res) {
                    var result;
                    if (res.id == '0') {
                        sessionStorage.removeItem(keyname);
                        var data = tool.base64Decode(res.data);
                        result = JSON.parse(tool.unicodeDecode(data));
                    } else {
                        var key = sessionStorage.getItem(res.id);
                        if (key == null) {
                            alert('系统密钥维护中，请稍后处理');
                            return false;
                        }
                        sessionStorage.removeItem(res.id);
                        var data = tool.base64Decode(aes.Decrypt(res.data, key));
                        data = tool.utf8to16(data);
                        var md5 = faultylabs.MD5(data + key);
                        if (md5 !== res.key) {
                            alert('系统签名维护中，请稍后处理');
                            return false;
                        }
                        result = JSON.parse(tool.unicodeDecode(data));
                    }
                    code = result.code;

                    if (code == 1) {
                        layer.msg("摄像头编号不合法,请维护正确的摄像头编号")
                    }
                    havesave = result.havesave;
                    havedel = result.havedel;


                },
                error: function (data) { }
            });
        }
    </script>
</body>

</html>